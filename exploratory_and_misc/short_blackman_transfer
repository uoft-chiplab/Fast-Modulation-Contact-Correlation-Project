'''
Created on 03-Nov-2025
This script explores the linear response transfer and systematics of
a short (20 us) Blackman pulse using HFT at various detunings.
This is part of an investigation in using HFT for dissipation measurements.
'''
import os
import sys
root_project = os.path.dirname(os.getcwd())

# Fast-Modulation-Contact-Correlation-Project\analysis
module_folder = os.path.join(root_project, "analysis")
if module_folder not in sys.path:
	sys.path.append(module_folder)
# settings for directories, standard packages...
from preamble import *

run = "2025-11-03_K"
# find data files
y, m, d, l = run[0:4], run[5:7], run[8:10], run[-1]
runpath = glob(f"{root_data}/{y}/{m}*{y}/{d}*{y}/{l}*/")[0] # note backslash included at end
datfiles = glob(f"{runpath}*=*.dat")
res_bc = 47.2227 # MHz at unitarity
ff = 0.88 # I hate this, TODO FIX
fig, ax = plt.subplots()
ax.set(xlabel='VVA', ylabel=r'Transfer $\alpha$')
for datfile in datfiles:
	data = Data(datfile, path=os.path.dirname(datfile))
	if data.data["freq"].values[0] < 47:
		continue # I messed up in one run
	
	# calc detuning and fudged c9
	data.data["detuning"] = data.data["freq"] - res_bc
	data.data["c9"] = data.data["c9"] * ff

	# this uses the new function inside the Data class
	df = data.find_transfer()

	ax.plot(df['VVA'], df['c5transfer'], ls='', marker='o', label=round(df['detuning'].values[0],2))

ax.legend(title='Detuning [MHz]')


	


	